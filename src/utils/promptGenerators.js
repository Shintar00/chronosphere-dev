import { performGPTReasoning } from './apiUtils';
import { parseGPTResponse } from './gptUtils';

const LEARNING_CUTOFF_DATE = '2023-10-01';

export const generateInitialPrompt = (query, timestamp) => {
  return `
現在の日付: ${timestamp}
GPTの学習データカットオフ日: ${LEARNING_CUTOFF_DATE}

質問: ${query}

以下の形式で回答してください。各セクションは必ず指定されたキーワードで始めてください：

最終回答: [質問に対する簡潔な回答]

補足事項:
- [関連する詳細情報]

時間的考察: [この回答が時間経過により変化する可能性について詳細に分析。過去、現在、未来の視点を含め、具体的な時期や年代を明記してください]

シナリオ分析:
シナリオ1: [説明] (妥当性評価: [評価]) (時期: [具体的な時期])
シナリオ2: [説明] (妥当性評価: [評価]) (時期: [具体的な時期])
シナリオ3: [説明] (妥当性評価: [評価]) (時期: [具体的な時期])

整合性チェック: [データの整合性チェック結果、時間的整合性も含む]

多角的考察:
経済的観点: [経済的な視点からの考察、時間軸を含む]
政治的観点: [政治的な視点からの考察、時間軸を含む]
社会的観点: [社会的な視点からの考察、時間軸を含む]
技術的観点: [技術的な視点からの考察、時間軸を含む]
文化的観点: [文化的な視点からの考察、時間軸を含む]

究極的自己一致性分析: [シナリオと全体の整合性を評価、時間軸を考慮。矛盾点や不確実性を詳細に分析し、それらがどのように全体の結論に影響するかを説明]

メタ分析: [あなたの推論プロセスの強みと限界について、時間的な要素も含めて。使用したデータソースの信頼性、潜在的なバイアス、分析の深さと広さについて批判的に評価]

自己修正プロセス: [初期の推論から最終的な結論に至るまでの思考の変化を説明、時間軸に沿って。どの部分が修正され、なぜその修正が必要だったかを詳細に記述]

代替解釈: [主要な結論とは異なる可能性のある解釈を提示、それぞれの時間的妥当性も考慮。これらの代替解釈がなぜ棄却されたか、または今後重要になる可能性があるかを説明]

次のステップ: [最新のデータを確認/現在の回答で進める]

注意: GPTの学習データと現在の日付を考慮し、時間経過による変化の可能性を詳細に分析してください。突然変異や特異点的な事象は慎重に扱い、主要な議論から外れすぎないようにしてください。各考察において、可能な限り具体的な時期や年代を明記してください。
`;
};

export const generateIterativePrompt = (query, previousResponse, timestamp, analysisHistory) => {
  const formattedAnalysisHistory = analysisHistory.map(analysis => 
    `イテレーション ${analysis.iteration}:\n` +
    `サマリー: ${analysis.summary}\n` +
    `主要な洞察: ${analysis.keyInsights.join(', ')}\n` +
    `変更点: ${analysis.changesFromPrevious}`
  ).join('\n\n');

  return `
現在の日付: ${timestamp}

質問: ${query}

前回の回答:
${JSON.stringify(previousResponse, null, 2)}

分析の進化の履歴:
${formattedAnalysisHistory}

上記の回答と分析の進化を再評価し、特に時間的な要素や最新データの重要性を強く意識して更新してください。前回の回答から変更がある場合は、その理由を詳細に説明してください。

以下の形式で更新された回答を提供してください：

最終回答: [更新された簡潔な回答]

補足事項:
- [更新された関連情報]

時間的考察: [新しい情報に基づく時間的な影響の詳細な分析、具体的な時期や年代を含む]

変更点: [前回の回答からの主な変更点と理由、時間的要因も含む]

シナリオ分析:
シナリオ1: [説明] (妥当性評価: [評価]) (時期: [具体的な時期])
シナリオ2: [説明] (妥当性評価: [評価]) (時期: [具体的な時期])
シナリオ3: [説明] (妥当性評価: [評価]) (時期: [具体的な時期])

整合性チェック: [データの整合性チェック結果、時間的整合性も含む]

多角的考察:
経済的観点: [経済的な視点からの考察、時間軸を含む]
政治的観点: [政治的な視点からの考察、時間軸を含む]
社会的観点: [社会的な視点からの考察、時間軸を含む]
技術的観点: [技術的な視点からの考察、時間軸を含む]
文化的観点: [文化的な視点からの考察、時間軸を含む]

究極的自己一致性分析: [シナリオと全体の整合性を評価、時間軸を考慮。前回の分析からの変化と、その理由を詳細に説明]

メタ分析: [あなたの推論プロセスの強みと限界について、時間的な要素も含めて。前回のメタ分析からの進展を説明]

自己修正プロセス: [初期の推論から最終的な結論に至るまでの思考の変化を説明、時間軸に沿って。新たな修正点とその理由を詳細に記述]

代替解釈: [主要な結論とは異なる可能性のある解釈を提示、それぞれの時間的妥当性も考慮。新たな代替解釈や、以前の解釈の再評価を含む]

次のステップ: [最新のデータを確認/現在の回答で進める]

注意: 突然変異や特異点的な事象は慎重に扱い、主要な議論から外れすぎないようにしてください。分析の進化を追跡し、どのように考察が深まったかを説明してください。各考察において、可能な限り具体的な時期や年代を明記してください。
`;
};

export const updateWithNews = async (query, news, currentResponse, timestamp) => {
  const formattedNews = news.map(item => `タイトル: ${item.title}\nURL: ${item.URL}\n内容: ${item.content}`).join('\n\n');
  
  const prompt = `
現在の日付: ${timestamp}

質問: ${query}

現在の回答:
${JSON.stringify(currentResponse, null, 2)}

最新のニュース情報:
${formattedNews}

上記の最新情報を考慮して、現在の回答を再評価し、必要に応じて更新してください。特に時間的な要素や最新データの重要性を強く意識してください。

以下の形式で更新された回答を提供してください：

最終回答: [更新された簡潔な回答]

補足事項:
- [更新された関連情報]

時間的考察: [新しい情報に基づく時間的な影響の詳細な分析]

変更点: [現在の回答からの主な変更点と理由]

シナリオ分析: [新しい情報に基づく更新されたシナリオ]

多角的考察: [新しい情報に基づく更新された多角的考察]

究極的自己一致性分析: [新しい情報を踏まえた全体の整合性評価]

メタ分析: [新しい情報源の信頼性と影響の評価]

自己修正プロセス: [新情報による思考の変化の説明]

代替解釈: [新情報に基づく新たな解釈の可能性]
`;

  const gptResponse = await performGPTReasoning(prompt);
  return parseGPTResponse(gptResponse);
};